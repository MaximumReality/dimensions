<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Maximum Reality: Dimensions</title>
  <style>
    body, html {
      margin:0; padding:0; width:100%; height:100%; overflow:hidden;
      background:#000; -webkit-user-select:none; touch-action:none;
      font-family: 'Courier New', monospace;
    }
    #gameCanvas {
      display:block; width:100vw; height:100vh; background:#000;
    }

    .ui-layer {
      position: absolute; top: env(safe-area-inset-top); left: 20px;
      color: #0ff; z-index: 100; pointer-events: none;
      text-shadow: 0 0 8px #0ff;
    }
    #score     { font-size: 24px; font-weight: bold; }
    #highScore { font-size: 14px; opacity: 0.8; margin-top: 5px; }
    #status    { font-size: 16px; margin-top: 8px; }

    .controls {
      position: absolute; top: calc(env(safe-area-inset-top) + 30px); right: 20px;
      display: flex; gap: 15px; z-index: 150;
    }
    .btn {
      font-size: 24px; background: rgba(0,255,255,0.15); border: 1.5px solid #0ff;
      border-radius: 8px; padding: 8px 12px; color: #0ff; cursor: pointer;
      backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center;
      user-select: none; touch-action: manipulation;
    }

    #bsod {
      position: fixed; inset: 0; background: #0000aa; color: #fff;
      font-family: 'Courier New'; display: none; z-index: 200;
      padding: 50px; box-sizing: border-box; text-align: center;
    }

    #flash {
      position: fixed; inset: 0; background: #fff; opacity: 0; z-index: 250;
      pointer-events: none; transition: opacity 0.1s;
    }

    #startOverlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.7); color: #0ff;
      z-index: 300; display: flex; align-items: center; justify-content: center;
      font-size: 48px; text-shadow: 0 0 15px #0ff; pointer-events: none;
    }
  </style>
</head>
<body>

<div id="bsod">
  <h1>:(</h1>
  <p>CRITICAL DIMENSION ERROR</p>
  <p>REBOOTING SIMULATION...</p>
</div>

<div id="flash"></div>

<div id="startOverlay">TAP TO START</div>

<div class="controls">
  <a href="https://maximumreality.xyz" class="btn">üè†</a>
  <div id="muteBtn"  class="btn">üîä</div>
  <div id="pauseBtn" class="btn">‚èØÔ∏è</div>
</div>

<div class="ui-layer">
  <div id="score">DIMENSION: 0</div>
  <div id="highScore">BEST: 0</div>
  <div id="status">ZONE: CYBER</div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CORE SETUP
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const canvas = document.getElementById('gameCanvas');
const ctx    = canvas.getContext('2d');

const bgMusic       = new Audio('password-infinity.mp3'); bgMusic.loop = true;
const beastModeSfx  = new Audio('beast_mode.mp3');

let isMuted       = false;
let isPaused      = false;
let gameState     = 'START'; // START | PLAYING | GAMEOVER
let score         = 0;
let highScore     = Number(localStorage.getItem('maxRealityHighScore')) || 0;
let frame         = 0;
let gameSpeed     = 7;
let dimensionHue  = 0;
let jumpHeight    = 0;
let yVelocity     = 0;
let shake         = 0;
let bonusCount    = 0;
let currentZone   = 'CYBER';
let portalActive  = false;
let beastModePlayed = false;
let lastPortalScore = 0;

const gravity       = 1.2;
const GROUND_Y_OFFSET = 100;
let floorY;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  ASSETS & LOOT TABLES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const ASSETS = {
  bg:             'gg-bg.png',
  snackBg:        'hot-food-c-store-wp.JPG',
  earthquakeBg:   'pompeii-bg.png',
  floor:          'floor.png',
  loriBlur:       'lori-blur.png',
  portal:         'snack-portal.png',
  azul:           ['Azul-doll.png','Azul-doll2.png','Azul-doll3.png','Azul-doll4.png'],
  buildings:      ['building-a.png','building-b.png','building-c.png'],
};

const CYBER_LOOT       = ['2tb.png','card.png','circuitpython.png','core-i7.png','core-i9.png','cpu-water-cooler.png','curve-keyboard.png','graphics-card.png','motherboard.png','optical-drive.png','power-supply.png','ram.png','ssd.png'];
const SNACK_LOOT       = ['azulo_blueberry_vanilla.jpg','bread-slice.png','chips.png','hotdog.png','mochkil-burger.png','mochkil_puffs_orange.png','pink-donut.png','roast-chicken.png','soda.png','taco.png'];
const EARTHQUAKE_LOOT  = ['book.png','scrolls.png','pottery.png','pottery2.png','pottery3.png','pottery4.png'];
const EARTHQUAKE_OBSTACLES = ['herc-bust.png','rubble.png'];

const imgCache = {
  CYBER_LOOT:       [],
  SNACK_LOOT:       [],
  EARTHQUAKE_LOOT:  [],
  EARTHQUAKE_OBSTACLES: [],
  azul:             [],
  buildings:        [],
};

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  PARTICLES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let particles = [];
class Particle {
  constructor(x, y, color, text = null, sizeMod = 1) {
    this.x = x; this.y = y;
    this.char = text || (Math.random() > 0.5 ? "0" : "1");
    this.size = (text ? 28 : Math.random() * 10 + 12) * sizeMod;
    this.speedX = (Math.random() - 0.5) * 10;
    this.speedY = (Math.random() - 0.5) * 10;
    this.color = color; this.life = 1.0;
  }
  update() { this.x += this.speedX; this.y += this.speedY; this.life -= 0.02; }
  draw() {
    ctx.save();
    ctx.fillStyle = this.color;
    ctx.globalAlpha = this.life;
    ctx.font = `bold ${this.size}px monospace`;
    ctx.fillText(this.char, this.x, this.y);
    ctx.restore();
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  LOAD ASSETS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function loadAssets() {
  // Single images
  ['bg','snackBg','earthquakeBg','floor','loriBlur','portal'].forEach(key => {
    const img = new Image();
    img.src = ASSETS[key];
    imgCache[key] = img;
  });

  // Arrays
  ASSETS.azul.forEach(src => {
    const img = new Image(); img.src = src;
    imgCache.azul.push(img);
  });

  ASSETS.buildings.forEach(src => {
    const img = new Image(); img.src = src;
    imgCache.buildings.push(img);
  });

  CYBER_LOOT.forEach(src => { const i = new Image(); i.src = src; imgCache.CYBER_LOOT.push(i); });
  SNACK_LOOT.forEach(src => { const i = new Image(); i.src = src; imgCache.SNACK_LOOT.push(i); });
  EARTHQUAKE_LOOT.forEach(src => { const i = new Image(); i.src = src; imgCache.EARTHQUAKE_LOOT.push(i); });
  EARTHQUAKE_OBSTACLES.forEach(src => { const i = new Image(); i.src = src; imgCache.EARTHQUAKE_OBSTACLES.push(i); });
}
loadAssets();

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  MATRIX RAIN (cyber background)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let drops = [];
function initMatrix() {
  drops = Array(Math.floor(canvas.width / 20)).fill(1);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  RESIZE & INIT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  floorY = canvas.height - GROUND_Y_OFFSET;
  initMatrix();
}
resize();
window.addEventListener('resize', resize);

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CONTROLS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

document.getElementById('muteBtn').addEventListener('touchstart', e => {
  e.stopPropagation();
  isMuted = !isMuted;
  bgMusic.muted = isMuted;
  beastModeSfx.muted = isMuted;
  document.getElementById('muteBtn').innerText = isMuted ? 'üîá' : 'üîä';
}, {passive: false});

document.getElementById('pauseBtn').addEventListener('touchstart', e => {
  e.stopPropagation();
  isPaused = !isPaused;
  document.getElementById('pauseBtn').style.borderColor = isPaused ? '#ff0' : '#0ff';
}, {passive: false});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  GAME STATE MACHINES
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function triggerBSOD() {
  gameState = 'GAMEOVER';
  bgMusic.pause();
  if (score > highScore) {
    highScore = score;
    localStorage.setItem('maxRealityHighScore', highScore);
  }
  document.getElementById('bsod').style.display = 'block';
  setTimeout(() => {
    document.getElementById('bsod').style.display = 'none';
    resetGame();
    gameState = 'START';
    document.getElementById('startOverlay').style.display = 'flex';
  }, 2200);
}

function resetGame() {
  score = 0;
  frame = 0;
  jumpHeight = 0;
  yVelocity = 0;
  shake = 0;
  bonusCount = 0;
  gameObjects = [];
  portalActive = false;
  beastModePlayed = false;
  lastPortalScore = 0;
  particles = [];
  currentZone = 'CYBER';
  gameSpeed = 7;
  dimensionHue = 0;
}

function flashScreen() {
  const f = document.getElementById('flash');
  f.style.opacity = 1;
  setTimeout(() => f.style.opacity = 0, 100);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  SPAWN LOGIC
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

let gameObjects = [];

function spawn() {
  // Portal every 5000 points
  if (score >= 5000 && score - lastPortalScore >= 5000 && !portalActive) {
    portalActive = true;
    lastPortalScore = score;
    gameObjects.push({
      x: canvas.width + 100,
      y: floorY - 140,
      w: 120,
      h: 140,
      type: 'portal',
      img: imgCache.portal
    });
    return;
  }

  let lootArr;
  if      (currentZone === 'CYBER')     lootArr = imgCache.CYBER_LOOT;
  else if (currentZone === 'SNACK')     lootArr = imgCache.SNACK_LOOT;
  else if (currentZone === 'EARTHQUAKE') lootArr = imgCache.EARTHQUAKE_LOOT;

  // Loot spawn
  if (frame % 80 === 0 && lootArr?.length > 0) {
    gameObjects.push({
      x: canvas.width + 100,
      y: floorY - 85,
      w: 80,
      h: 80,
      type: 'tech',
      img: lootArr[Math.floor(Math.random() * lootArr.length)]
    });
  }

  // Obstacles
  if (currentZone === 'CYBER' && frame % 180 === 0) {
    const img = new Image();
    img.src = 'old-pc.png';
    gameObjects.push({
      x: canvas.width + 100,
      y: floorY - 90,
      w: 80,
      h: 80,
      type: 'obstacle',
      img
    });
  }

  if (currentZone === 'EARTHQUAKE' && frame % 200 === 0) {
    const obsArr = imgCache.EARTHQUAKE_OBSTACLES;
    if (obsArr?.length > 0) {
      gameObjects.push({
        x: canvas.width + 100,
        y: floorY - 90,
        w: 80,
        h: 80,
        type: 'obstacle',
        img: obsArr[Math.floor(Math.random() * obsArr.length)]
      });
    }
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  BACKGROUND RENDERING
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function drawBackground() {
  ctx.fillStyle = '#000';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  if (currentZone === 'SNACK' && imgCache.snackBg?.complete) {
    const x = -((frame * 2) % canvas.width);
    ctx.drawImage(imgCache.snackBg, x, 0, canvas.width, canvas.height);
    ctx.drawImage(imgCache.snackBg, x + canvas.width, 0, canvas.width, canvas.height);
  }
  else if (currentZone === 'EARTHQUAKE' && imgCache.earthquakeBg?.complete) {
    const x = -((frame * 1.5) % canvas.width);
    ctx.drawImage(imgCache.earthquakeBg, x, 0, canvas.width, canvas.height);
    ctx.drawImage(imgCache.earthquakeBg, x + canvas.width, 0, canvas.width, canvas.height);
  }
  else { // CYBER
    if (imgCache.bg?.complete) {
      ctx.drawImage(imgCache.bg, 0, 0, canvas.width, canvas.height);
    }
    if (imgCache.loriBlur?.complete) {
      ctx.save();
      ctx.globalAlpha = 0.4;
      const lX = -((frame * 0.5) % canvas.width);
      ctx.drawImage(imgCache.loriBlur, lX, 0, canvas.width, canvas.height);
      ctx.drawImage(imgCache.loriBlur, lX + canvas.width, 0, canvas.width, canvas.height);
      ctx.restore();
    }

    // Parallax buildings
    const layers = [
      {img: imgCache.buildings[2], speed: 0.8,  opacity: 0.2, height: 550},
      {img: imgCache.buildings[1], speed: 1.8,  opacity: 0.4, height: 450},
      {img: imgCache.buildings[0], speed: 3.5,  opacity: 0.6, height: 350}
    ];
    layers.forEach(l => {
      if (l.img?.complete) {
        ctx.save();
        const x = -((frame * l.speed) % canvas.width);
        ctx.globalAlpha = l.opacity;
        ctx.filter = `hue-rotate(${dimensionHue}deg)`;
        ctx.drawImage(l.img, x, floorY - l.height, canvas.width, l.height);
        ctx.drawImage(l.img, x + canvas.width, floorY - l.height, canvas.width, l.height);
        ctx.restore();
      }
    });

    // Matrix rain
    ctx.save();
    ctx.fillStyle = `hsl(${dimensionHue}, 100%, 60%)`;
    ctx.font = "bold 18px monospace";
    drops.forEach((y, i) => {
      ctx.fillText(Math.random() > 0.5 ? "1" : "0", i * 20, y * 20);
      if (y * 20 > canvas.height && Math.random() > 0.975) drops[i] = 0;
      drops[i]++;
    });
    ctx.restore();
  }

  // Ground
  ctx.fillStyle = currentZone === 'EARTHQUAKE' ? '#440' : "#222";
  ctx.fillRect(0, floorY, canvas.width, GROUND_Y_OFFSET);

  if (imgCache.floor?.complete) {
    const fX = -((frame * gameSpeed) % 100);
    for (let i = -1; i < (canvas.width / 100) + 2; i++) {
      ctx.drawImage(imgCache.floor, (i * 100) + fX, floorY, 100, GROUND_Y_OFFSET);
    }
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  MAIN GAME LOOP
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function loop() {
  if (isPaused) {
    requestAnimationFrame(loop);
    return;
  }

  ctx.save();

  // Screen shake
  if (shake > 0) {
    ctx.translate((Math.random() - 0.5) * shake, (Math.random() - 0.5) * shake);
    shake *= 0.88;
    if (shake < 0.2) shake = 0;
  }

  ctx.clearRect(0, 0, canvas.width, canvas.height);

  drawBackground();

  // Particles
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.update();
    p.draw();
    if (p.life <= 0) particles.splice(i, 1);
  }

  if (gameState === 'PLAYING') {
    frame++;
    spawn();

    // Player physics
    jumpHeight -= yVelocity;
    yVelocity += gravity;
    let landed = false;
    if (jumpHeight <= 0) {
      jumpHeight = 0;
      if (yVelocity > 0) landed = true;
      yVelocity = 0;
    }

    if (currentZone === 'CYBER' && landed && beastModePlayed) shake = Math.max(shake, 5);
    if (currentZone === 'EARTHQUAKE') shake = Math.max(shake, 15);

    // Draw Azul
    const animFrame = Math.floor(frame / 6) % 4;
    if (imgCache.azul[animFrame]?.complete) {
      ctx.drawImage(imgCache.azul[animFrame], 100, floorY - 110 - jumpHeight, 90, 115);
    }

    // ‚îÄ‚îÄ‚îÄ Objects (reverse loop = safe removal) ‚îÄ‚îÄ‚îÄ
    for (let i = gameObjects.length - 1; i >= 0; i--) {
      const obj = gameObjects[i];
      obj.x -= gameSpeed;

      const nearPlayer = obj.x < 160 && obj.x > 80;

      if (nearPlayer) {
        if (obj.type === 'tech' && jumpHeight < 70) {
          bonusCount = Math.min(bonusCount + 1, 10);
          const points = 100 * bonusCount;
          score += points;
          dimensionHue += 5;

          particles.push(new Particle(obj.x, obj.y, '#fff', `+${points}`));
          for (let j = 0; j < 12; j++) {
            particles.push(new Particle(obj.x, obj.y, `hsl(${dimensionHue},100%,60%)`));
          }
          gameObjects.splice(i, 1);
          continue;
        }
        else if (obj.type === 'portal') {
          flashScreen();

          if (currentZone === 'CYBER') {
            currentZone = 'SNACK';
            gameSpeed = 7;
          }
          else if (currentZone === 'SNACK') {
            currentZone = 'EARTHQUAKE';
            gameSpeed = 12;
            beastModeSfx.currentTime = 0;
            beastModeSfx.play();
            beastModePlayed = true;
          }
          else {
            currentZone = 'CYBER';
            gameSpeed = 7;
            beastModePlayed = false;
          }

          bonusCount = 0;
          portalActive = false;
          gameObjects = [];
          particles = [];
          break; // exit loop after reset
        }
        else if (obj.type === 'obstacle' && jumpHeight < 70) {
          triggerBSOD();
        }
      }

      // Draw object
      if (obj.img?.complete) {
        ctx.drawImage(obj.img, obj.x, obj.y, obj.w, obj.h);
      }

      // Off-screen cleanup
      if (obj.x < -150) {
        gameObjects.splice(i, 1);
      }
    }

    // UI update
    document.getElementById('score').innerText     = `DIMENSION: ${score}`;
    document.getElementById('highScore').innerText = `BEST: ${highScore}`;
    document.getElementById('status').innerText    = `ZONE: ${currentZone}`;
  }

  ctx.restore();
  requestAnimationFrame(loop);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  INPUT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

window.addEventListener('touchstart', e => {
  if (e.target.closest('.btn') || e.target.closest('#bsod')) return;

  if (gameState === 'START') {
    document.getElementById('startOverlay').style.display = 'none';
    resetGame();
    gameState = 'PLAYING';
    bgMusic.play().catch(() => {}); // autoplay may be blocked
  }
  else if (gameState === 'PLAYING' && jumpHeight === 0) {
    yVelocity = -22;
  }

  e.preventDefault();
}, {passive: false});

// Start loop
loop();
</script>
</body>
</html>
