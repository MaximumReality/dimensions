<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Maximum Reality: Binary Infinity</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; -webkit-user-select: none; touch-action: none; }
        #gameCanvas { display: block; width: 100vw; height: 100vh; background: #000; }
        
        /* UI HUD */
        .ui-layer {
            position: absolute; top: env(safe-area-inset-top); left: 20px;
            color: #0ff; font-family: 'Courier New', monospace;
            z-index: 100; pointer-events: none; text-shadow: 0 0 8px #0ff;
        }
        #score { font-size: 24px; font-weight: bold; }
        #multiplier { font-size: 16px; color: #fff; }
        
        /* INTERACTIVE CONTROLS */
        .controls {
            position: absolute; top: env(safe-area-inset-top); right: 20px;
            display: flex; gap: 15px; z-index: 150;
        }
        .btn { 
            font-size: 24px; background: rgba(0, 255, 255, 0.1); border: 1px solid #0ff; 
            border-radius: 8px; padding: 5px 10px; color: #0ff; cursor: pointer;
            backdrop-filter: blur(5px);
        }
        .home-btn { text-decoration: none; display: flex; align-items: center; justify-content: center; }

        #bsod {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #0000aa; color: #fff; font-family: 'Courier New';
            display: none; z-index: 200; padding: 50px; box-sizing: border-box;
        }
    </style>
</head>
<body>
    <div id="bsod">
        <h1>:(</h1>
        <p>CRITICAL_DIMENSION_ERROR</p>
        <p>REBOOTING SIMULATION...</p>
    </div>

    <div class="controls">
        <a href="https://MaximumReality.xyz" class="btn home-btn">üè†</a>
        <div id="muteBtn" class="btn">üîä</div>
        <div id="pauseBtn" class="btn">‚èØÔ∏è</div>
    </div>

    <div class="ui-layer">
        <div id="score">DIMENSION: 0</div>
        <div id="multiplier">X1</div>
        <div id="highScore">BEST: 0</div>
    </div>
    <canvas id="gameCanvas"></canvas>

<script>
<script>
// ... (Asset loading and setup remains the same)

// --- 1. RESTORED PARTICLE CLASS ---
class Particle {
    constructor(x, y, color, text = null) {
        this.x = x; this.y = y;
        this.char = text || ["0", "1"][Math.floor(Math.random() * 2)];
        this.size = text ? 28 : Math.random() * 10 + 12;
        this.speedX = text ? (Math.random() - 0.5) * 5 : (Math.random() - 0.5) * 12;
        this.speedY = text ? -5 : (Math.random() - 0.5) * 12;
        this.color = color;
        this.life = 1.0;
    }
    update() { this.x += this.speedX; this.y += this.speedY; this.life -= 0.025; }
    draw() {
        ctx.save(); ctx.fillStyle = this.color; ctx.globalAlpha = this.life;
        ctx.font = `bold ${this.size}px monospace`;
        ctx.fillText(this.char, this.x, this.y); ctx.restore();
    }
}

let particles = []; // Array to hold the "juice"

// --- 2. UPDATED SPAWN (5000 Point Milestone) ---
function spawn() {
    // Portals now only every 5000 points
    const milestone = Math.floor(score / 5000) * 5000;
    if (score >= 5000 && milestone > lastPortalMilestone && !portalActive) {
        lastPortalMilestone = milestone;
        portalActive = true;
        gameObjects.push({ 
            x: canvas.width + 100, y: floorY - 140, w: 120, h: 140, 
            type: 'portal', img: imgCache.portal 
        });
    }
    
    // Regular item spawning
    if (frame % 80 === 0) {
        const isLoot = Math.random() > 0.3;
        const currentList = (currentZone === 'CYBER') ? imgCache.loot : imgCache.snacks;
        const idx = Math.floor(Math.random() * currentList.length);
        gameObjects.push({
            x: canvas.width + 100, y: floorY - 85, w: 80, h: 80,
            type: isLoot ? 'tech' : 'obstacle',
            img: isLoot ? currentList[idx] : imgCache.obstacles[0]
        });
    }
}

// --- 3. UPDATED LOOP (Particle Handling & Splash) ---
function loop() {
    if (isPaused) { requestAnimationFrame(loop); return; }
    ctx.save();
    if (shake > 0) { ctx.translate(Math.random()*shake, Math.random()*shake); shake *= 0.85; }
    draw();

    // UPDATE AND DRAW PARTICLES
    particles.forEach((p, index) => {
        p.update(); p.draw();
        if (p.life <= 0) particles.splice(index, 1);
    });

    if (gameState === 'PLAYING') {
        frame++; spawn();
        
        // ... (Azul movement logic) ...

        gameObjects.forEach((obj, i) => {
            obj.x -= gameSpeed * timeScale;
            
            const hitboxH = (obj.type === 'tech') ? 75 : 60;
            if (obj.x < 160 && obj.x > 80 && jumpHeight < hitboxH) {
                if (obj.type === 'portal') {
                    // Portal Entry Splash
                    for(let j=0; j<25; j++) particles.push(new Particle(obj.x, obj.y, "#fff"));
                    
                    currentZone = (currentZone === 'CYBER') ? 'SNACK' : 'CYBER';
                    gameSpeed = (currentZone === 'SNACK') ? 12 : 7;
                    timeScale = 1.0; portalActive = false; gameObjects = [];
                } else if (obj.type === 'tech') {
                    // --- THE JUICE ---
                    const pCol = (currentZone === 'CYBER') ? "#0ff" : "#ff0";
                    // Exploding 0s and 1s
                    for(let j=0; j<12; j++) particles.push(new Particle(obj.x + 40, obj.y + 40, pCol));
                    // Floating "Score" Text
                    particles.push(new Particle(obj.x, obj.y, "#fff", `+${100 * combo}`));
                    
                    score += (100 * combo); 
                    combo++; 
                    shake = 8; 
                    gameObjects.splice(i, 1);
                } else if (currentZone === 'CYBER') {
                    triggerBSOD();
                }
            }
            // ... (rest of object logic) ...
        });
    }
    // ...
    ctx.restore();
    requestAnimationFrame(loop);
}
</script>

</body>
</html>
